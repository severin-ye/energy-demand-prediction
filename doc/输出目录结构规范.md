# 输出目录结构规范

**作者**: Severin YE  
**日期**: 2026-01-16  
**版本**: v2.0

---

## 新的目录结构

```
outputs/
├── training/           # 训练结果目录
│   ├── 26-01-16/      # 按日期命名（YY-MM-DD）
│   │   ├── models/     # 模型文件
│   │   │   ├── parallel_model.keras
│   │   │   ├── bayesian_network.bif
│   │   │   └── ...
│   │   └── results/    # 训练结果
│   │       ├── train_history.json
│   │       └── ...
│   ├── 26-01-17/      # 另一天的训练
│   └── ...
│
└── inference/          # 推理结果目录
    ├── 26-01-16/       # 按模型目录名分组（训练日期）
    │   ├── 26-01-16_19-30/  # 推理时间（YY-MM-DD_HH-MM）
    │   │   ├── html_reports/
    │   │   ├── inference_report.txt
    │   │   └── ...
    │   └── 26-01-16_20-15/  # 同一模型的另一次推理
    │       └── ...
    └── 26-01-17/       # 另一个模型的推理
        └── 26-01-17_10-00/
            └── ...
```

---

## 命名规则

### 训练输出
- **路径**: `outputs/training/{YY-MM-DD}/`
- **格式**: `YY-MM-DD` (年-月-日，两位数)
- **示例**: 
  - `outputs/training/26-01-16/`
  - `outputs/training/26-01-17/`

### 推理输出
- **路径**: `outputs/inference/{模型日期}/{YY-MM-DD_HH-MM}/`
- **第一级**: 模型训练日期（从model-dir提取）
- **第二级**: 推理运行时间
- **格式**: `YY-MM-DD_HH-MM` (年-月-日_时-分)
- **示例**:
  - `outputs/inference/26-01-16/26-01-16_19-30/`
  - `outputs/inference/26-01-16/26-01-16_20-15/`

---

## 代码实现

### 训练脚本 (run_training.py)

```python
from datetime import datetime

# 自动生成日期目录
if args.output_dir is None:
    date_suffix = datetime.now().strftime('%y-%m-%d')
    args.output_dir = f'./outputs/training/{date_suffix}'
```

**命令行使用**:
```bash
# 自动使用日期目录
python scripts/run_training.py --data data/uci/splits/train.csv --epochs 10

# 手动指定目录（覆盖默认）
python scripts/run_training.py --data xxx.csv --output-dir custom/path
```

### 推理脚本 (run_inference_uci.py)

```python
from datetime import datetime
from pathlib import Path

# 自动生成 模型名/时间 目录
if args.output_dir is None:
    # 从模型目录提取名称
    model_dir_path = Path(args.model_dir)
    if model_dir_path.parent.name == 'models':
        # 如果是 xxx/models，取上一级目录名
        model_name = model_dir_path.parent.parent.name
    else:
        model_name = model_dir_path.parent.name
    
    timestamp = datetime.now().strftime('%y-%m-%d_%H-%M')
    args.output_dir = f'outputs/inference/{model_name}/{timestamp}'
```

**命令行使用**:
```bash
# 自动使用 模型名/时间 目录
python scripts/run_inference_uci.py \
  --model-dir outputs/training/26-01-16/models \
  --test-data data/uci/splits/test.csv

# 输出到: outputs/inference/26-01-16/26-01-16_19-30/
```

---

## 使用示例

### 场景 1: 训练新模型
```bash
cd /home/severin/Codelib/YS
source .venv/bin/activate

# 训练（自动保存到 outputs/training/26-01-16/）
python scripts/run_training.py \
  --data data/uci/splits/train.csv \
  --epochs 10 \
  --batch-size 32
```

**结果**:
```
outputs/training/26-01-16/
├── models/
│   ├── parallel_model.keras
│   ├── bayesian_network.bif
│   └── ...
└── results/
    └── train_history.json
```

### 场景 2: 同一天训练多次
```bash
# 第一次训练（上午9点）
python scripts/run_training.py --data data1.csv
# → outputs/training/26-01-16/  （会覆盖）

# 第二次训练（下午3点，需要保留上午的）
python scripts/run_training.py --data data2.csv \
  --output-dir outputs/training/26-01-16_afternoon
```

### 场景 3: 推理测试
```bash
# 使用 26-01-16 训练的模型进行推理
python scripts/run_inference_uci.py \
  --model-dir outputs/training/26-01-16/models \
  --test-data data/uci/splits/test.csv \
  --n-samples 50
```

**结果**:
```
outputs/inference/26-01-16/26-01-16_19-30/
├── html_reports/
│   ├── index.html
│   └── sample_*.html
├── inference_report.txt
└── inference_results.json
```

### 场景 4: 多次推理对比
```bash
# 第一次推理（19:30）
python scripts/run_inference_uci.py \
  --model-dir outputs/training/26-01-16/models \
  --test-data test1.csv
# → outputs/inference/26-01-16/26-01-16_19-30/

# 第二次推理（20:15，不同测试集）
python scripts/run_inference_uci.py \
  --model-dir outputs/training/26-01-16/models \
  --test-data test2.csv
# → outputs/inference/26-01-16/26-01-16_20-15/

# 结果对比
ls outputs/inference/26-01-16/
# 26-01-16_19-30/
# 26-01-16_20-15/
```

---

## 优势

### 1. 层次清晰
```
training/  - 所有训练结果
inference/ - 所有推理结果
```

### 2. 时间可追溯
- 训练: 按日期组织
- 推理: 按模型+时间组织

### 3. 便于管理
```bash
# 清理某天的训练
rm -rf outputs/training/26-01-15

# 清理某模型的所有推理
rm -rf outputs/inference/26-01-15

# 查看某模型的所有推理记录
ls outputs/inference/26-01-16/
```

### 4. 自动化
- 无需手动指定目录
- 避免命名混乱
- 支持手动覆盖

---

## 注意事项

### 同一天多次训练
⚠️ **默认会覆盖**: 同一天多次训练会使用相同目录 `training/26-01-16/`

**解决方案**:
```bash
# 方案1: 手动指定不同后缀
python scripts/run_training.py ... \
  --output-dir outputs/training/26-01-16_v2

# 方案2: 使用时分秒（需要修改代码）
# datetime.now().strftime('%y-%m-%d_%H-%M-%S')
```

### 推理目录提取
推理脚本会自动从 `--model-dir` 提取模型名称：
- `outputs/training/26-01-16/models` → 模型名: `26-01-16`
- `custom/my_model/models` → 模型名: `my_model`

---

## 迁移指南

### 清理旧目录
```bash
cd /home/severin/Codelib/YS

# 备份（可选）
tar -czf outputs_old_backup.tar.gz outputs/

# 清理旧的混乱命名
rm -rf outputs/inference*
rm -rf outputs/training_run*
rm -rf outputs/training_uci

# 保留新结构
# outputs/training/26-01-16/
# outputs/inference/.../
```

### 重新生成结果
```bash
# 1. 训练新模型
python scripts/run_training.py \
  --data data/uci/splits/train.csv \
  --epochs 10 \
  --batch-size 32

# 2. 运行推理
python scripts/run_inference_uci.py \
  --model-dir outputs/training/26-01-16/models \
  --test-data data/uci/splits/test.csv \
  --n-samples 50

# 3. 查看结果
tree outputs/ -L 3
```

---

## 文件版本

- **v1.0**: 初始实现（2026-01-16）
- **当前**: v2.0 - 分层目录结构

**路径**: `doc/输出目录结构规范.md`
