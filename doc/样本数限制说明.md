# æ ·æœ¬æ•°é™åˆ¶è¯´æ˜

**ä½œè€…**: Severin YE  
**æ—¥æœŸ**: 2026-01-16

---

## é—®é¢˜ï¼šä¸ºä»€ä¹ˆæ ·æœ¬æ•°å¤ªå°‘ä¼šå¯¼è‡´æ¨ç†é”™è¯¯ï¼Ÿ

### æ ¸å¿ƒåŸå› ï¼šåºåˆ—é•¿åº¦è¦æ±‚

æ¨¡å‹ä½¿ç”¨**æ»‘åŠ¨çª—å£**æœºåˆ¶æ¥åˆ›å»ºæ—¶é—´åºåˆ—ï¼Œè®­ç»ƒé…ç½®ä¸­ `sequence_length=20`ã€‚

---

## åŸç†è¯´æ˜

### åºåˆ—ç”Ÿæˆæœºåˆ¶

```python
def create_sequences(data, sequence_length=20):
    """åˆ›å»ºæ»‘åŠ¨çª—å£åºåˆ—"""
    X, y = [], []
    
    # å…³é”®å¾ªç¯
    for i in range(len(data) - sequence_length):
        X.append(data[i:i + sequence_length])  # å–20ä¸ªè¿ç»­æ ·æœ¬ä½œä¸ºè¾“å…¥
        y.append(data[i + sequence_length])     # ç¬¬21ä¸ªæ ·æœ¬ä½œä¸ºç›®æ ‡
    
    return X, y
```

### å›¾è§£

```
æ ·æœ¬æ•° = 25ï¼Œsequence_length = 20

åŸå§‹æ•°æ®: [0, 1, 2, 3, ..., 24]

åºåˆ—1: [0-19]  â†’ ç›®æ ‡20
åºåˆ—2: [1-20]  â†’ ç›®æ ‡21
åºåˆ—3: [2-21]  â†’ ç›®æ ‡22
åºåˆ—4: [3-22]  â†’ ç›®æ ‡23
åºåˆ—5: [4-23]  â†’ ç›®æ ‡24

å¯ç”Ÿæˆåºåˆ—æ•° = 25 - 20 = 5 ä¸ª
```

---

## è®¡ç®—å…¬å¼

```
åºåˆ—æ•° = max(0, æ ·æœ¬æ•° - sequence_length)
```

### æ ·æœ¬æ•°ä¸åºåˆ—æ•°å¯¹ç…§è¡¨

| æ ·æœ¬æ•° | sequence_length | åºåˆ—æ•° | çŠ¶æ€ |
|--------|----------------|--------|------|
| 10     | 20             | 0      | âŒ æ— æ³•è¿è¡Œ |
| 20     | 20             | 0      | âŒ æ— æ³•è¿è¡Œ |
| 21     | 20             | 1      | âš ï¸ å¤ªå°‘ |
| 25     | 20             | 5      | âš ï¸ å¤ªå°‘ |
| 30     | 20             | 10     | âš ï¸ å‹‰å¼º |
| 50     | 20             | 30     | âœ… å¯ç”¨ |
| 100    | 20             | 80     | âœ…âœ… æ¨è |

---

## é”™è¯¯æµç¨‹åˆ†æ

### å½“æ ·æœ¬æ•°=20æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

```
1ï¸âƒ£ ç”¨æˆ·è¾“å…¥
   --n-samples 20

2ï¸âƒ£ æ•°æ®åŠ è½½
   df.shape = (20, 4)

3ï¸âƒ£ åºåˆ—ç”Ÿæˆ
   for i in range(20 - 20):  # range(0) â†’ ç©ºå¾ªç¯
       ...
   
   ç»“æœ: X=[], y=[]  â† ç©ºæ•°ç»„ï¼

4ï¸âƒ£ æ¨¡å‹é¢„æµ‹
   model.predict(X)  # X.shape = (0, 20, 3)
   
   Keraså†…éƒ¨:
   - æ£€æµ‹åˆ°batch_size=0
   - è·³è¿‡æ‰€æœ‰å¾ªç¯
   - batch_outputs å˜é‡ä»æœªèµ‹å€¼

5ï¸âƒ£ è®¿é—®å˜é‡
   return batch_outputs  â† ğŸ’¥ å˜é‡æœªå®šä¹‰ï¼
   
   é”™è¯¯: UnboundLocalError: cannot access local variable 
         'batch_outputs' where it is not associated with a value
```

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä½¿ç”¨è¶³å¤Ÿçš„æ ·æœ¬æ•°ï¼ˆæ¨èï¼‰

```bash
# âœ… æ¨èåšæ³•
python scripts/run_inference_uci.py \
  --model-dir outputs/training/26-01-16/models \
  --test-data data/uci/splits/test.csv \
  --n-samples 50    # æˆ–æ›´å¤š
```

### æ–¹æ¡ˆ2: ä½¿ç”¨å…¨éƒ¨æµ‹è¯•æ•°æ®

```bash
# âœ… ä½¿ç”¨æ‰€æœ‰å¯ç”¨æ•°æ®
python scripts/run_inference_uci.py \
  --model-dir outputs/training/26-01-16/models \
  --test-data data/uci/splits/test.csv \
  --n-samples 1000  # å¤§äºæµ‹è¯•é›†å¤§å°å³å¯
```

### æ–¹æ¡ˆ3: ä¿®æ”¹é…ç½®ï¼ˆä¸æ¨èï¼‰

å¦‚æœç¡®å®éœ€è¦å°æ ·æœ¬æ¨ç†ï¼Œéœ€è¦ï¼š
1. é‡æ–°è®­ç»ƒæ¨¡å‹ï¼Œä½¿ç”¨æ›´å°çš„ `sequence_length`
2. ä¿®æ”¹ `src/preprocessing/data_preprocessor.py` ä¸­çš„é»˜è®¤å€¼

```python
# ä¸æ¨èï¼šéœ€è¦é‡æ–°è®­ç»ƒ
def __init__(self, ..., sequence_length: int = 10):  # æ”¹ä¸º10
```

---

## å®é™…å»ºè®®

### æ¨ç†æ—¶çš„æ ·æœ¬æ•°è¦æ±‚

| ç”¨é€” | æœ€å°æ ·æœ¬æ•° | æ¨èæ ·æœ¬æ•° | è¯´æ˜ |
|------|-----------|-----------|------|
| å¿«é€Ÿæµ‹è¯• | 30 | 50 | ç”Ÿæˆ10-30ä¸ªåºåˆ— |
| æ€§èƒ½è¯„ä¼° | 50 | 100 | ç»Ÿè®¡æ›´å¯é  |
| å®Œæ•´è¯„ä¼° | 100 | å…¨éƒ¨æµ‹è¯•é›† | æœ€å‡†ç¡®çš„è¯„ä¼° |
| HTMLæŠ¥å‘Š | 50 | 100+ | è‡³å°‘ç”Ÿæˆ10ä¸ªè¯¦ç»†æŠ¥å‘Š |

### ä¸ºä»€ä¹ˆéœ€è¦æ›´å¤šæ ·æœ¬ï¼Ÿ

1. **ç»Ÿè®¡æ„ä¹‰**: 
   - 30ä¸ªåºåˆ— â†’ åŸºæœ¬å¯ä¿¡
   - 80ä¸ªåºåˆ— â†’ è¾ƒå¯ä¿¡
   - 1000+åºåˆ— â†’ é«˜åº¦å¯ä¿¡

2. **HTMLæŠ¥å‘Š**: 
   - é»˜è®¤ç”Ÿæˆå‰10ä¸ªæ ·æœ¬çš„è¯¦ç»†æŠ¥å‘Š
   - éœ€è¦è‡³å°‘30ä¸ªåºåˆ—æ‰æœ‰æ„ä¹‰

3. **çŠ¶æ€åˆ†å¸ƒ**:
   - Peak/Normal/Lower ä¸‰ç§çŠ¶æ€
   - æ ·æœ¬è¶Šå¤šï¼Œåˆ†å¸ƒè¶Šå‡†ç¡®

4. **å¯è§†åŒ–**:
   - æ•°æ®ç‚¹å¤ªå°‘ â†’ å›¾è¡¨æ— æ„ä¹‰
   - æ•°æ®ç‚¹å……è¶³ â†’ è¶‹åŠ¿æ¸…æ™°

---

## ç°æœ‰ä¿æŠ¤æœºåˆ¶

### è‡ªåŠ¨æ£€æŸ¥ï¼ˆå·²æ·»åŠ ï¼‰

```python
def load_test_data(test_file, n_samples=100, min_samples=50):
    """åŠ è½½æµ‹è¯•æ•°æ®ï¼Œè‡ªåŠ¨æ£€æŸ¥æ ·æœ¬æ•°"""
    
    if actual_samples < min_samples:
        logger.error("âŒ æ ·æœ¬æ•°ä¸è¶³ï¼")
        logger.error(f"   å½“å‰æ ·æœ¬æ•°: {actual_samples}")
        logger.error(f"   æœ€å°è¦æ±‚: {min_samples}")
        logger.error("\nåŸå› : æ¨¡å‹ä½¿ç”¨åºåˆ—é•¿åº¦=20ï¼Œéœ€è¦è‡³å°‘50ä¸ªæ ·æœ¬")
        logger.error("è®¡ç®—å…¬å¼: åºåˆ—æ•° = æ ·æœ¬æ•° - 20")
        logger.error("   â€¢ æ ·æœ¬æ•°=20 â†’ åºåˆ—æ•°=0  âŒ")
        logger.error("   â€¢ æ ·æœ¬æ•°=50 â†’ åºåˆ—æ•°=30 âœ…")
        raise ValueError("æ ·æœ¬æ•°ä¸è¶³")
```

### é”™è¯¯æç¤ºç¤ºä¾‹

```
âŒ æ ·æœ¬æ•°ä¸è¶³ï¼
   å½“å‰æ ·æœ¬æ•°: 20
   æœ€å°è¦æ±‚: 50

åŸå› : æ¨¡å‹ä½¿ç”¨åºåˆ—é•¿åº¦=20ï¼Œéœ€è¦è‡³å°‘50ä¸ªæ ·æœ¬æ‰èƒ½ç”Ÿæˆè¶³å¤Ÿçš„åºåˆ—
è®¡ç®—å…¬å¼: åºåˆ—æ•° = æ ·æœ¬æ•° - 20
   â€¢ æ ·æœ¬æ•°=20 â†’ åºåˆ—æ•°=0  âŒ
   â€¢ æ ·æœ¬æ•°=30 â†’ åºåˆ—æ•°=10 âš ï¸
   â€¢ æ ·æœ¬æ•°=50 â†’ åºåˆ—æ•°=30 âœ…

è§£å†³æ–¹æ¡ˆ:
   python scripts/run_inference_uci.py \
     --model-dir outputs/training/26-01-16/models \
     --test-data data/uci/splits/test.csv \
     --n-samples 50  # æˆ–æ›´å¤š
```

---

## æ¼”ç¤ºè„šæœ¬

è¿è¡Œä»¥ä¸‹è„šæœ¬å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„åºåˆ—ç”Ÿæˆè¿‡ç¨‹ï¼š

```bash
python scripts/explain_sequence_length.py
```

**è¾“å‡ºå†…å®¹**:
- ä¸åŒæ ·æœ¬æ•°çš„åºåˆ—ç”Ÿæˆæ¼”ç¤º
- batch_outputs é”™è¯¯åŸå› è§£é‡Š
- å®é™…é¡¹ç›®ä¸­çš„æœ€å°æ ·æœ¬æ•°å»ºè®®

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ ¹æœ¬åŸå› **: æ»‘åŠ¨çª—å£æœºåˆ¶è¦æ±‚ `æ ·æœ¬æ•° > sequence_length`
2. **æœ€å°è¦æ±‚**: æ ·æœ¬æ•° â‰¥ 21ï¼ˆä»…ç”Ÿæˆ1ä¸ªåºåˆ—ï¼Œæ— å®ç”¨ä»·å€¼ï¼‰
3. **å®‰å…¨å€¼**: æ ·æœ¬æ•° â‰¥ 50ï¼ˆç”Ÿæˆ30ä¸ªåºåˆ—ï¼‰âœ…
4. **æ¨èå€¼**: æ ·æœ¬æ•° â‰¥ 100ï¼ˆç”Ÿæˆ80+åºåˆ—ï¼‰âœ…âœ…

### å¿«é€Ÿå‚è€ƒ

```bash
# âŒ ä¼šæŠ¥é”™
--n-samples 20

# âš ï¸ èƒ½è¿è¡Œä½†æ•°æ®å¤ªå°‘
--n-samples 30

# âœ… æ¨è
--n-samples 50
--n-samples 100
--n-samples 1000  # æ›´å¥½
```

### è®°å¿†å£è¯€

> **åºåˆ—æ•° = æ ·æœ¬æ•° - 20**
> 
> è‡³å°‘50ä¸ªæ ·æœ¬ï¼Œæ‰èƒ½è·‘å¾—æ¬¢ï¼

---

**æ–‡æ¡£è·¯å¾„**: `doc/æ ·æœ¬æ•°é™åˆ¶è¯´æ˜.md`  
**ç›¸å…³è„šæœ¬**: `scripts/explain_sequence_length.py`  
**æœ€åæ›´æ–°**: 2026-01-16
